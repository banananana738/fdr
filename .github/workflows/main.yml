name: Remote Desktop Access

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'RDP Password (min 6 chars)'
        required: true
        default: 'Pass123!'
        type: string

env:
  NGROK_TOKEN: "2yTGXjOucmtLbslj4gHvfhPMMtD_7WvugEqip6Y3Utun6Em4n"

jobs:
  remote-desktop:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
    # STEP 1: Basic setup
    - name: Setup Windows
      run: |
        echo "=== Step 1: Basic Setup ==="
        echo "Current directory: $pwd"
        echo "Running as: $(whoami)"
        
    # STEP 2: Enable RDP (SIMPLE VERSION)
    - name: Enable RDP
      run: |
        echo "=== Step 2: Enabling RDP ==="
        
        # Method 1: Use PowerShell to enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        
        # Method 2: Also use reg command
        reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        
        echo "RDP Registry updated"
        
        # Open firewall (ALL methods)
        netsh advfirewall firewall add rule name="Open RDP Port 3389" dir=in action=allow protocol=TCP localport=3389
        
        # Also try PowerShell method
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        echo "Firewall configured"
        
    # STEP 3: Create user
    - name: Create User
      env:
        RDP_PASS: ${{ github.event.inputs.password }}
      run: |
        echo "=== Step 3: Creating User ==="
        
        # Store password securely
        $securePass = ConvertTo-SecureString "$env:RDP_PASS" -AsPlainText -Force
        
        # Try multiple methods
        try {
            # Method 1: PowerShell
            New-LocalUser -Name "rdpuser" -Password $securePass -FullName "RDP User" -Description "GitHub Runner"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpuser"
            Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
            echo "User created with PowerShell"
        } catch {
            echo "PowerShell method failed, trying NET command..."
            # Method 2: NET command (more reliable)
            net user rdpuser "$env:RDP_PASS" /add /y
            net localgroup "Remote Desktop Users" rdpuser /add
            net localgroup administrators rdpuser /add
            echo "User created with NET command"
        }
        
        echo "USERNAME=rdpuser" >> $env:GITHUB_ENV
        echo "User 'rdpuser' created successfully"
        
    # STEP 4: Download Ngrok (FIXED VERSION)
    - name: Get Ngrok
      run: |
        echo "=== Step 4: Downloading Ngrok ==="
        
        # Create directory
        New-Item -ItemType Directory -Path "ngrok" -Force
        
        # Download ngrok using GitHub's cache-friendly URL
        $downloadUrl = "https://github.com/ngrok/ngrok/releases/download/v3.5.0/ngrok-v3.5.0-windows-amd64.zip"
        
        echo "Downloading from: $downloadUrl"
        
        # Use different download methods
        try {
            # Method 1: Invoke-WebRequest
            Invoke-WebRequest -Uri $downloadUrl -OutFile "ngrok.zip" -UserAgent "GitHubActions"
            echo "Downloaded via Invoke-WebRequest"
        } catch {
            echo "Method 1 failed, trying curl..."
            # Method 2: curl
            curl -L $downloadUrl -o ngrok.zip
            echo "Downloaded via curl"
        }
        
        # Verify download
        if (Test-Path "ngrok.zip") {
            $size = (Get-Item "ngrok.zip").Length / 1MB
            echo "Download successful: $size MB"
            
            # Extract
            Expand-Archive -Path "ngrok.zip" -DestinationPath "ngrok" -Force
            
            # Verify extraction
            if (Test-Path "ngrok/ngrok.exe") {
                echo "âœ… Ngrok extracted successfully"
            } else {
                # Try alternative extraction
                echo "Looking for ngrok.exe..."
                Get-ChildItem -Path "ngrok" -Recurse | Where-Object { $_.Name -like "*ngrok*" } | Select-Object Name
            }
        } else {
            echo "âŒ Download failed"
            # List what we have
            Get-ChildItem
        }
        
    # STEP 5: Setup Ngrok with token
    - name: Configure Ngrok
      run: |
        echo "=== Step 5: Configuring Ngrok ==="
        
        # Set location
        Set-Location -Path "ngrok"
        
        # Check if ngrok exists
        if (Test-Path "ngrok.exe") {
            echo "Ngrok.exe found"
        } else {
            # Try to find it
            $ngrokExe = Get-ChildItem -Path "." -Filter "*ngrok*.exe" -Recurse | Select-Object -First 1
            if ($ngrokExe) {
                echo "Found: $($ngrokExe.FullName)"
                Copy-Item -Path $ngrokExe.FullName -Destination "ngrok.exe" -Force
            }
        }
        
        # Setup auth token
        echo "Setting up Ngrok token..."
        
        # YOUR TOKEN HERE
        $token = "2yTGXjOucmtLbslj4gHvfhPMMtD_7WvugEqip6Y3Utun6Em4n"
        
        # Authenticate
        .\ngrok.exe authtoken $token
        
        if ($LASTEXITCODE -eq 0) {
            echo "âœ… Ngrok authentication successful"
        } else {
            echo "âŒ Ngrok auth failed"
            echo "Testing token validity..."
            
            # Test token format
            if ($token.Length -lt 20) {
                echo "Token seems too short"
            }
            
            # Get new token from: https://dashboard.ngrok.com/get-started/your-authtoken
            echo "Get new token from: https://dashboard.ngrok.com"
        }
        
    # STEP 6: Start Ngrok tunnel
    - name: Start Tunnel
      run: |
        echo "=== Step 6: Starting Tunnel ==="
        
        # Start ngrok for RDP
        echo "Starting ngrok on port 3389..."
        
        # Method: Start as background job
        Start-Job -Name "NgrokTunnel" -ScriptBlock {
            Set-Location "$using:PWD\ngrok"
            .\ngrok.exe tcp 3389 --log stdout
        }
        
        # Wait a bit
        Start-Sleep -Seconds 10
        
        # Check if ngrok is running
        $process = Get-Process -Name "ngrok" -ErrorAction SilentlyContinue
        if ($process) {
            echo "âœ… Ngrok process running (PID: $($process.Id))"
        } else {
            echo "âš ï¸ Ngrok process not found, checking jobs..."
            Get-Job | Format-List
        }
        
        # Try to get tunnel info (retry multiple times)
        $tunnelUrl = $null
        for ($i = 1; $i -le 10; $i++) {
            try {
                echo "Attempt $i to get tunnel info..."
                $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 3
                
                if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                    $tunnelUrl = $response.tunnels[0].public_url
                    $tunnelUrl = $tunnelUrl -replace 'tcp://', ''
                    echo "âœ… Tunnel URL: $tunnelUrl"
                    break
                }
            } catch {
                echo "API not ready yet..."
            }
            Start-Sleep -Seconds 3
        }
        
        if ($tunnelUrl) {
            echo "RDP_URL=$tunnelUrl" >> $env:GITHUB_ENV
        else {
            echo "âš ï¸ Could not get tunnel URL automatically"
            echo "Check ngrok output above for manual URL"
        }
        
    # STEP 7: Display connection info
    - name: Show Connection Details
      run: |
        echo ""
        echo "############################################"
        echo "#        REMOTE DESKTOP READY              #"
        echo "############################################"
        echo ""
        
        if ($env:RDP_URL) {
            $parts = $env:RDP_URL -split ':'
            echo "ðŸŒ ADDRESS: $($parts[0])"
            echo "ðŸšª PORT: $($parts[1])"
        } else {
            echo "ðŸŒ ADDRESS: 0.tcp.ngrok.io"
            echo "ðŸšª PORT: (check ngrok output above)"
        }
        
        echo "ðŸ‘¤ USERNAME: $env:USERNAME"
        echo "ðŸ” PASSWORD: ${{ github.event.inputs.password }}"
        echo ""
        echo "ðŸ“± HOW TO CONNECT:"
        echo "1. Open Remote Desktop (mstsc.exe)"
        echo "2. Enter: address:port"
        echo "3. Username: $env:USERNAME"
        echo "4. Password: ${{ github.event.inputs.password }}"
        echo ""
        echo "â° AVAILABLE FOR: 5.5 hours"
        echo "############################################"
        
    # STEP 8: Keep alive
    - name: Wait and Keep Alive
      run: |
        echo "=== Keeping session active ==="
        
        # Show timer
        $endTime = (Get-Date).AddMinutes(330)  # 5.5 hours
        
        while ((Get-Date) -lt $endTime) {
            $minutesLeft = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 0)
            
            # Clear line and show progress
            Write-Host "`r[$(Get-Date -Format 'HH:mm:ss')] RDP Active - $minutesLeft minutes left   " -NoNewline
            
            # Show connection info every 5 minutes
            if ($minutesLeft % 5 -eq 0) {
                Write-Host ""
                Write-Host "   Connect using: $env:RDP_URL"
                Write-Host "   Username: $env:USERNAME"
            }
            
            Start-Sleep -Seconds 60
        }
        
        Write-Host ""
        Write-Host "â° Session ending in 10 minutes..."
        
    # STEP 9: Run your scripts
    - name: Run Custom Scripts
      run: |
        echo "=== Running your scripts ==="
        
        # Check for your Downloads.bat
        if (Test-Path "../Downloads.bat") {
            echo "Found Downloads.bat, running..."
            Set-Location ..
            cmd /c "Downloads.bat"
        } else {
            echo "No Downloads.bat found"
            echo "Creating test environment..."
            
            # Create test files
            @"
echo RDP Session Active
echo Connected via GitHub Actions + Ngrok
echo Username: %USERNAME%
echo Date: %DATE%
echo Time: %TIME%
pause
"@ | Out-File -FilePath "test.bat" -Encoding ASCII
            
            cmd /c "test.bat"
        }
        
    # STEP 10: Cleanup
    - name: Cleanup
      if: always()
      run: |
        echo "=== Cleaning up ==="
        
        # Stop ngrok
        Stop-Job -Name "NgrokTunnel" -ErrorAction SilentlyContinue
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        
        # Remove user
        net user $env:USERNAME /delete /y 2>$null
        
        echo "âœ… Cleanup complete"
