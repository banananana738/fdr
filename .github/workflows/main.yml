name: programmingwithkumaresan-rdp

on:
  workflow_dispatch:
    inputs:
      enable_rdp:
        description: 'Enable RDP via Ngrok'
        required: true
        default: 'true'
        type: boolean
      rdp_password:
        description: 'Windows password (min 6 chars)'
        required: false
        default: 'GitHubRDP123'
        type: string

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 355
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure Windows RDP
        if: ${{ github.event.inputs.enable_rdp == 'true' }}
        env:
          WIN_PASSWORD: ${{ secrets.RDP_PASSWORD || github.event.inputs.rdp_password }}
        run: |
          Write-Host "Setting up Windows Remote Desktop..."
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          
          # Create/Reset local user for RDP
          $username = "github-runner"
          $password = ConvertTo-SecureString $env:WIN_PASSWORD -AsPlainText -Force
          
          # Check if user exists
          try {
              $user = Get-LocalUser -Name $username -ErrorAction Stop
              Write-Host "User exists, updating password..."
              Set-LocalUser -Name $username -Password $password
          } catch {
              Write-Host "Creating new user..."
              New-LocalUser -Name $username -Password $password -FullName "GitHub Runner" -Description "Temporary RDP user"
          }
          
          # Add to Remote Desktop Users group
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # Add to Administrators group (if needed)
          Add-LocalGroupMember -Group "Administrators" -Member $username
          
          # Disable Network Level Authentication for easier connection
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0
          
          # Restart RDP service
          Restart-Service -Name TermService -Force
          
          Write-Host "Windows RDP configured successfully!"
          Write-Host "Username: $username"
          Write-Host "Password: *******"
          
      - name: Install and Configure Ngrok
        if: ${{ github.event.inputs.enable_rdp == 'true' }}
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          Write-Host "Setting up Ngrok tunnel for RDP..."
          
          # Download ngrok
          $ngrokUrl = "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
          Invoke-WebRequest -Uri $ngrokUrl -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "." -Force
          
          # Check if auth token is provided
          if ([string]::IsNullOrEmpty($env:NGROK_AUTH_TOKEN)) {
              Write-Host "WARNING: No Ngrok auth token provided!"
              Write-Host "You need to sign up at ngrok.com and get a free token"
              Write-Host "Then add it as GitHub secret: NGROK_AUTH_TOKEN"
              exit 1
          }
          
          # Configure ngrok with auth token
          .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          # Create ngrok config file for RDP
          $ngrokConfig = @"
version: "2"
authtoken: $env:NGROK_AUTH_TOKEN
tunnels:
  rdp:
    proto: tcp
    addr: 3389
    bind_tls: false
"@
          
          $ngrokConfig | Out-File -FilePath "ngrok.yml" -Encoding UTF8
          
          # Start ngrok tunnel for RDP
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -NoNewWindow
          
          # Wait for tunnel to establish
          Start-Sleep -Seconds 10
          
          # Get tunnel URL
          $tunnelInfo = .\ngrok.exe tunnel list --format json | ConvertFrom-Json
          
          if ($tunnelInfo) {
              $rdpTunnel = $tunnelInfo | Where-Object { $_.name -eq "rdp" -or $_.proto -eq "tcp" }
              if ($rdpTunnel) {
                  $rdpUrl = $rdpTunnel.public_url
                  echo "RDP_URL=$rdpUrl" >> $env:GITHUB_ENV
                  Write-Host "‚úÖ RDP Tunnel URL: $rdpUrl"
              }
          }
          
          # Alternative: Get from ngrok API
          Start-Sleep -Seconds 5
          $apiResponse = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction SilentlyContinue
          if ($apiResponse) {
              foreach ($tunnel in $apiResponse.tunnels) {
                  if ($tunnel.proto -eq "tcp") {
                      $rdpUrl = $tunnel.public_url
                      echo "RDP_URL=$rdpUrl" >> $env:GITHUB_ENV
                      Write-Host "üåê RDP Public URL: $rdpUrl"
                      break
                  }
              }
          }
          
      - name: Display RDP Connection Information
        if: ${{ github.event.inputs.enable_rdp == 'true' }}
        run: |
          Write-Host ""
          Write-Host "=================================================="
          Write-Host "üñ•Ô∏è  WINDOWS RDP REMOTE DESKTOP READY"
          Write-Host "=================================================="
          Write-Host "üë§ Username: github-runner"
          
          if ($env:WIN_PASSWORD) {
              Write-Host "üîê Password: $env:WIN_PASSWORD"
          } else {
              Write-Host "üîê Password: (see input or secret)"
          }
          
          if (-not [string]::IsNullOrEmpty($env:RDP_URL)) {
              # Parse ngrok URL (format: tcp://0.tcp.ngrok.io:12345)
              $rdpUrl = $env:RDP_URL
              $rdpUrl = $rdpUrl -replace 'tcp://', ''
              $hostPort = $rdpUrl -split ':'
              $rdpHost = $hostPort[0]
              $rdpPort = $hostPort[1]
              
              Write-Host "üåê Connection: $rdpHost:$rdpPort"
              Write-Host ""
              Write-Host "üìù How to connect:"
              Write-Host "1. Open Remote Desktop Connection (mstsc)"
              Write-Host "2. Computer: $rdpHost:$rdpPort"
              Write-Host "3. Username: github-runner"
              Write-Host "4. Password: (above)"
              Write-Host ""
              Write-Host "üîó Quick connect string:"
              Write-Host "mstsc /v:$rdpHost`:$rdpPort"
              
              # Generate RDP file
              $rdpContent = @"
full address:s:$rdpHost`:$rdpPort
username:s:github-runner
"@
              $rdpContent | Out-File -FilePath "connection.rdp" -Encoding UTF8
              Write-Host "üíæ RDP file saved: connection.rdp"
          } else {
              Write-Host "‚ö†Ô∏è  RDP URL not available yet"
              Write-Host "üí° Check ngrok setup or wait a moment"
          }
          
          Write-Host "‚è±Ô∏è  Session Duration: 6 hours maximum"
          Write-Host "=================================================="
          
      - name: Keep Session Alive
        if: ${{ github.event.inputs.enable_rdp == 'true' }}
        run: |
          Write-Host "RDP session active..."
          Write-Host "Ngrok tunnel: $env:RDP_URL"
          Write-Host "Username: github-runner"
          
          # Display countdown
          $endTime = (Get-Date).AddMinutes(350)
          while ((Get-Date) -lt $endTime) {
              $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP active - $remaining minutes left"
              Start-Sleep -Seconds 60
          }
          
          Write-Host "‚ö†Ô∏è  Time limit reached! Session ending soon..."
          
      - name: Run Your Custom Scripts
        run: |
          Write-Host "Running your scripts while RDP is available..."
          
          # Run your Downloads.bat
          if (Test-Path "Downloads.bat") {
              Write-Host "Executing Downloads.bat..."
              cmd /c Downloads.bat
          }
          
          # Install tools if needed
          # choco install -y git python vscode
          
      - name: Cleanup
        if: always()
        run: |
          Write-Host "Cleaning up..."
          
          # Kill ngrok
          Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
          
          # Disable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 1
          
          # Delete temp user
          Remove-LocalUser -Name "github-runner" -ErrorAction SilentlyContinue
          
          Write-Host "Cleanup complete!"
