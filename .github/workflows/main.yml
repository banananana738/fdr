name: RDP with Ngrok

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'RDP Password'
        required: true
        default: 'Pass123!'
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 330
    
    steps:
    # Step 1: Enable RDP
    - name: Enable Remote Desktop
      run: |
        # Enable RDP
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        
        # Open firewall
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        
        echo "RDP enabled"
        
    # Step 2: Create user
    - name: Create RDP User
      env:
        RDP_PASS: ${{ github.event.inputs.password }}
      run: |
        # Create user
        net user runner "$env:RDP_PASS" /add /y
        net localgroup "Remote Desktop Users" runner /add
        net localgroup administrators runner /add
        
        echo "USERNAME=runner" >> $env:GITHUB_ENV
        echo "User created"
        
    # Step 3: Download ngrok
    - name: Get Ngrok
      run: |
        # Download ngrok
        curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -o ngrok.zip
        
        # Extract
        tar -xf ngrok.zip
        echo "Ngrok ready"
        
    # Step 4: Setup ngrok with your token
    - name: Configure Ngrok
      run: |
        # Your ngrok token
        ./ngrok authtoken 2yTGXjOucmtLbslj4gHvfhPMMtD_7WvugEqip6Y3Utun6Em4n
        echo "Ngrok configured"
        
    # Step 5: Start tunnel
    - name: Start RDP Tunnel
      run: |
        # Start ngrok in background
        Start-Process ./ngrok -ArgumentList "tcp 3389" -NoNewWindow
        
        # Wait for tunnel
        sleep 10
        
        # Get tunnel URL
        $tunnel = curl -s http://localhost:4040/api/tunnels | ConvertFrom-Json
        $url = $tunnel.tunnels[0].public_url -replace 'tcp://', ''
        echo "RDP_URL=$url" >> $env:GITHUB_ENV
        echo "Tunnel: $url"
        
    # Step 6: Display info
    - name: Show Connection Info
      run: |
        echo ""
        echo "========================================"
        echo "RDP CONNECTION READY"
        echo "========================================"
        echo "Connect to: $env:RDP_URL"
        echo "Username: $env:USERNAME"
        echo "Password: ${{ github.event.inputs.password }}"
        echo "========================================"
        echo ""
        echo "To connect:"
        echo "mstsc /v:$env:RDP_URL"
        echo ""
        
    # Step 7: Keep alive
    - name: Wait
      run: |
        # Wait 5 hours
        sleep 18000
        echo "Session ending soon..."
        
    # Step 8: Cleanup
    - name: Cleanup
      if: always()
      run: |
        # Stop ngrok
        Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
        
        # Delete user
        net user runner /delete /y 2>$null
        
        echo "Done"
