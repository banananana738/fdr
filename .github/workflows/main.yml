name: Windows RDP Fast

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Try every 6 hours

jobs:
  windows-rdp:
    # Strategy to retry if no runner
    strategy:
      max-parallel: 1
      matrix:
        os: [windows-2022, windows-2019, windows-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Check if Windows runner is ready
      run: |
        echo "Windows runner acquired!"
        echo "OS: $RUNNER_OS"
        echo "Starting RDP setup..."
        
    - name: Enable RDP
      run: |
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        
    - name: Create User
      run: |
        net user rdpuser Password123! /add
        net localgroup "Remote Desktop Users" rdpuser /add
        
    - name: Get Ngrok
      run: |
        curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -o ngrok.zip
        tar -xf ngrok.zip
        
    - name: Setup Ngrok
      run: |
        ./ngrok authtoken 2yTGXjOucmtLbslj4gHvfhPMMtD_7WvugEqip6Y3Utun6Em4n
        
    - name: Start Tunnel
      run: |
        Start-Process ./ngrok -ArgumentList "tcp 3389" -NoNewWindow
        sleep 10
        $tunnel = curl -s http://localhost:4040/api/tunnels | ConvertFrom-Json
        $url = $tunnel.tunnels[0].public_url -replace 'tcp://', ''
        echo "RDP_URL=$url" >> $env:GITHUB_ENV
        
    - name: Show Info
      run: |
        echo ""
        echo "=== RDP READY ==="
        echo "Connect to: $env:RDP_URL"
        echo "Username: rdpuser"
        echo "Password: Password123!"
        echo "Time: $(date)"
        echo ""
        
    - name: Keep Alive
      run: |
        # 5.5 hour countdown
        for i in {1..330}; do
          echo "Active: $i/330 minutes"
          sleep 60
        done
