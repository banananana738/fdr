name: programmingwithkumaresan-rdp-fixed

on:
  workflow_dispatch:
    inputs:
      rdp_password:
        description: 'RDP Password'
        required: true
        default: 'GitHubRDP2024'
        type: string

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 355
    
    steps:
      - name: Enable Windows RDP
        run: |
          echo "=== Enabling Remote Desktop ==="
          
          # 1. Enable RDP in registry
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          
          # 2. Allow through firewall
          netsh advfirewall firewall add rule name="RDP Port 3389" dir=in action=allow protocol=TCP localport=3389
          
          # 3. Disable NLA for easier connection
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          
          echo "RDP configuration complete"
          
      - name: Create Windows User
        env:
          WIN_PASS: ${{ github.event.inputs.rdp_password }}
        run: |
          echo "=== Creating RDP User ==="
          
          # Create user with NET command (most reliable)
          net user githubrunner "$env:WIN_PASS" /add /y
          net localgroup "Remote Desktop Users" githubrunner /add
          net localgroup administrators githubrunner /add
          
          echo "User 'githubrunner' created successfully"
          echo "USERNAME=githubrunner" >> $env:GITHUB_ENV
          
      - name: Setup Ngrok with YOUR Token
        run: |
          echo "=== Setting up Ngrok ==="
          
          # Download ngrok (using working URL)
          $ProgressPreference = 'SilentlyContinue'
          Write-Host "Downloading ngrok..."
          
          # Try multiple download sources
          try {
              Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          } catch {
              Write-Host "Trying alternative download..."
              Invoke-WebRequest -Uri "https://github.com/ngrok/ngrok/releases/download/v3.5.0/ngrok-v3.5.0-windows-amd64.zip" -OutFile "ngrok.zip"
          }
          
          # Extract
          if (Test-Path "ngrok.zip") {
              Expand-Archive -Path "ngrok.zip" -DestinationPath "." -Force
              Write-Host "Ngrok extracted successfully"
          } else {
              Write-Host "ERROR: Failed to download ngrok"
              exit 1
          }
          
          # Setup with YOUR token
          Write-Host "Configuring ngrok with your token..."
          
          # YOUR NGROK TOKEN HERE - Replace with yours
          $NGROK_TOKEN = "2yTGXjOucmtLbslj4gHvfhPMMtD_7WvugEqip6Y3Utun6Em4n"
          
          # Authenticate
          .\ngrok.exe authtoken $NGROK_TOKEN
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ… Ngrok authentication successful!"
          } else {
              Write-Host "âŒ Ngrok authentication failed"
              Write-Host "Check your token or get a new one from ngrok.com"
              exit 1
          }
          
      - name: Start RDP Tunnel
        run: |
          echo "=== Starting RDP Tunnel ==="
          
          # Start ngrok for RDP
          Write-Host "Starting ngrok tunnel on port 3389..."
          
          # Start ngrok in background
          $ngrokProcess = Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -PassThru -NoNewWindow
          
          # Save process ID
          echo "NGROK_PID=$($ngrokProcess.Id)" >> $env:GITHUB_ENV
          
          # Wait for tunnel to establish
          Write-Host "Waiting for tunnel to establish..."
          Start-Sleep -Seconds 15
          
          # Get tunnel information
          Write-Host "Getting tunnel details..."
          
          $maxAttempts = 10
          for ($i = 1; $i -le $maxAttempts; $i++) {
              try {
                  $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 5
                  
                  if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                      $tunnel = $response.tunnels[0]
                      $publicUrl = $tunnel.public_url
                      
                      # Remove tcp:// prefix
                      $publicUrl = $publicUrl -replace 'tcp://', ''
                      
                      echo "RDP_URL=$publicUrl" >> $env:GITHUB_ENV
                      Write-Host "âœ… Tunnel established: $publicUrl"
                      break
                  }
              } catch {
                  Write-Host "Attempt $i/$maxAttempts: Waiting for tunnel..."
                  Start-Sleep -Seconds 5
              }
          }
          
          if ([string]::IsNullOrEmpty($env:RDP_URL)) {
              Write-Host "âš ï¸ Could not get tunnel URL from API"
              Write-Host "Check ngrok output above for manual URL"
          }
          
      - name: Display Connection Instructions
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ðŸ–¥ï¸  REMOTE DESKTOP CONNECTION READY         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if (-not [string]::IsNullOrEmpty($env:RDP_URL)) {
              $urlParts = $env:RDP_URL -split ':'
              $hostname = $urlParts[0]
              $port = $urlParts[1]
              
              echo "ðŸŒ CONNECTION DETAILS:"
              echo "   Host: $hostname"
              echo "   Port: $port"
              echo "   ðŸ‘¤ Username: $env:USERNAME"
              echo "   ðŸ” Password: ${{ github.event.inputs.rdp_password }}"
              echo ""
              echo "ðŸ“± HOW TO CONNECT:"
              echo ""
              echo "1. On Windows:"
              echo "   Press Win + R, type 'mstsc', press Enter"
              echo "   Computer: $hostname`:$port"
              echo ""
              echo "2. Command line:"
              echo "   mstsc /v:$hostname`:$port"
              echo ""
              echo "3. Save as RDP file:"
              echo "   full address:s:$hostname`:$port"
              echo "   username:s:$env:USERNAME"
              echo ""
              echo "4. On Mac/Linux:"
              echo "   Use Microsoft Remote Desktop app"
              echo "   PC name: $hostname`:$port"
              echo ""
              
              # Generate quick connect command
              echo "âš¡ QUICK CONNECT:"
              echo "   mstsc /v:$env:RDP_URL"
              
          } else {
              echo "âš ï¸  Tunnel URL not available"
              echo "Check the 'Start RDP Tunnel' step above for ngrok output"
          }
          
          echo ""
          echo "â° SESSION DURATION: 6 hours"
          echo "ðŸ“… Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          echo ""
          
      - name: Monitor Session
        run: |
          # Keep session alive for 5.5 hours
          $endTime = (Get-Date).AddMinutes(330)
          
          while ((Get-Date) -lt $endTime) {
              $timeLeft = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 0)
              $percent = [math]::Round((330 - $timeLeft) / 330 * 100, 0)
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active - $timeLeft minutes left"
              
              # Show connection info every 10 minutes
              if ($timeLeft % 10 -eq 0 -and -not [string]::IsNullOrEmpty($env:RDP_URL)) {
                  Write-Host "   ðŸ”— Connect via: $env:RDP_URL"
                  Write-Host "   ðŸ‘¤ Username: $env:USERNAME"
              }
              
              Start-Sleep -Seconds 60
          }
          
          Write-Host "â° Session time ending in 30 minutes..."
          
      - name: Run Your Custom Scripts
        run: |
          echo "=== Running Your Scripts ==="
          
          # If you have Downloads.bat, run it
          if (Test-Path "Downloads.bat") {
              echo "Running Downloads.bat..."
              cmd /c "Downloads.bat"
          } else {
              echo "No Downloads.bat found, creating example..."
              
              # Create example script
              @"
@echo off
echo ========================================
echo   GitHub Actions RDP Session
echo ========================================
echo Date: %date%
echo Time: %time%
echo Username: %username%
echo Computer: %computername%
echo ========================================
echo.
echo Installing example tools...
echo.

REM Example installations (commented out)
REM choco install -y git python nodejs

echo.
echo RDP Session Active via Ngrok
echo ========================================
pause
"@ | Out-File -FilePath "Downloads.bat" -Encoding ASCII
              
              cmd /c "Downloads.bat"
          }
          
      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning Up ==="
          
          # Kill ngrok
          if (-not [string]::IsNullOrEmpty($env:NGROK_PID)) {
              Write-Host "Stopping ngrok (PID: $env:NGROK_PID)..."
              Stop-Process -Id $env:NGROK_PID -Force -ErrorAction SilentlyContinue
          }
          
          # Kill all ngrok processes
          Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
          
          # Delete user
          Write-Host "Removing user..."
          net user $env:USERNAME /delete /y 2>$null
          
          # Disable RDP
          Write-Host "Disabling RDP..."
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f
          
          # Remove firewall rule
          netsh advfirewall firewall delete rule name="RDP Port 3389" 2>$null
          
          Write-Host "âœ… Cleanup complete!"
