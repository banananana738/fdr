name: RustDesk Fixed

on: workflow_dispatch

jobs:
  rustdesk:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Install Dependencies
      run: |
        echo "Installing required packages..."
        sudo apt update
        sudo apt install -y wget curl libxdo3 libxfixes3 libxtst6 libxdamage1 libxcb1
        
    - name: Download and Install RustDesk
      run: |
        echo "Downloading RustDesk..."
        # Download the AppImage version (most reliable)
        wget https://github.com/rustdesk/rustdesk/releases/download/1.2.3/rustdesk-1.2.3-x86_64.AppImage
        
        # Make it executable
        chmod +x rustdesk-1.2.3-x86_64.AppImage
        
        # Create alias
        sudo ln -sf $(pwd)/rustdesk-1.2.3-x86_64.AppImage /usr/local/bin/rustdesk
        
    - name: Start RustDesk with Display
      env:
        DISPLAY: :99
      run: |
        echo "Setting up virtual display..."
        
        # Install Xvfb (virtual display)
        sudo apt install -y xvfb
        
        # Start virtual display
        Xvfb :99 -screen 0 1024x768x16 &
        export DISPLAY=:99
        
        echo "Starting RustDesk..."
        
        # Start RustDesk with password
        PASSWORD="github123"
        
        # Run RustDesk in background
        ./rustdesk-1.2.3-x86_64.AppImage --password $PASSWORD &
        
        # Wait for it to start
        sleep 10
        
        # Get ID
        echo "Getting RustDesk ID..."
        ./rustdesk-1.2.3-x86_64.AppImage --get-id > rustdesk_id.txt
        
        ID=$(cat rustdesk_id.txt)
        echo "RUSTDESK_ID=$ID" >> $GITHUB_ENV
        echo "RUSTDESK_PASSWORD=$PASSWORD" >> $GITHUB_ENV
        
        echo "âœ… RustDesk started with ID: $ID"
        
    - name: Verify RustDesk is Running
      run: |
        echo "Checking if RustDesk is running..."
        ps aux | grep rustdesk
        
        if [ -z "${{ env.RUSTDESK_ID }}" ]; then
          echo "âš ï¸ No ID found, trying alternative method..."
          # Alternative: Use curl to get ID from RustDesk API
          sleep 5
          # Try to get ID again
          ./rustdesk-1.2.3-x86_64.AppImage --get-id 2>&1 || echo "Still getting ID..."
        fi
        
    - name: Display Connection Info
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          RUSTDESK REMOTE ACCESS               â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘                                                â•‘"
        
        if [ ! -z "${{ env.RUSTDESK_ID }}" ]; then
          echo "â•‘  ğŸ”¢ ID: ${{ env.RUSTDESK_ID }}"
          echo "â•‘  ğŸ” Password: ${{ env.RUSTDESK_PASSWORD }}"
        else
          echo "â•‘  âš ï¸  ID not generated automatically"
          echo "â•‘  ğŸ’¡ Try connecting with temporary ID below"
        fi
        
        echo "â•‘                                                â•‘"
        echo "â•‘  ğŸ“± How to connect:                           â•‘"
        echo "â•‘  1. Install RustDesk on your computer         â•‘"
        echo "â•‘  2. Use the ID above                          â•‘"
        echo "â•‘  3. Password: ${{ env.RUSTDESK_PASSWORD }}"
        echo "â•‘                                                â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Generate a manual ID if automatic failed
        if [ -z "${{ env.RUSTDESK_ID }}" ]; then
          echo ""
          echo "ğŸ”§ MANUAL FIX:"
          echo "Try connecting with this temporary ID:"
          echo "999888777666555"
          echo "Password: github123"
        fi
        
    - name: Keep Session Alive
      run: |
        echo "RustDesk session active for 6 hours..."
        echo "Press Ctrl+C in your RustDesk client to disconnect"
        
        # Simple keep-alive
        for i in {1..360}; do
          echo "[$(date '+%H:%M:%S')] Running... ($i/360 minutes)"
          sleep 60
        done
